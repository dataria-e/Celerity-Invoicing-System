{% extends 'base.html' %}

{% block content %}
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between gap-2 flex-wrap">
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addVendorModal">
        Add Vendor
      </button>
      <button type="button" class="btn btn-sm" id="editVendorButton" disabled>
        Edit Vendor
      </button>
      <button type="button" class="btn btn-sm btn-danger" id="deleteVendorButton" disabled>
        Delete Vendor
      </button>
    </div>

    <form id="vendorsSearchForm" method="get" action="{{ url_for('vendors_page') }}" class="d-flex" style="max-width: 280px; width: 100%;">
      <div class="input-group input-group-sm">
        <input
          id="vendorsSearchInput"
          type="text"
          class="form-control"
          name="q"
          placeholder="Search vendors..."
          value="{{ search_query or '' }}"
        />
        <button type="submit" class="btn btn-sm">Search</button>
      </div>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-vcenter card-table" id="vendorsTable">
      <thead>
        <tr>
          <th style="width: 48px;"></th>
          <th>Vendor Number</th>
          <th>Vendor Type</th>
          <th>Vendor Name</th>
          <th>Vendor Tax Number</th>
          <th>Registration Name</th>
          <th>Phone Number</th>
          <th>Address</th>
          <th>Website</th>
          <th>Country</th>
          <th>Address 2</th>
        </tr>
      </thead>
      <tbody>
        {% for vendor in vendors %}
        <tr class="vendor-row">
          <td>
            <input
              type="radio"
              name="selected_vendor"
              value="{{ vendor.id }}"
              data-id="{{ vendor.id }}"
              data-vendor-number="{{ vendor.vendor_number }}"
              data-vendor-type="{{ vendor.vendor_type or 'Company' }}"
              data-vendor-name="{{ vendor.vendor_name }}"
              data-vendor-tax-number="{{ vendor.vendor_tax_number or '' }}"
              data-registration-name="{{ vendor.registration_name or '' }}"
              data-phone-number="{{ vendor.phone_number or '' }}"
              data-address="{{ vendor.address or '' }}"
              data-website="{{ vendor.website or '' }}"
              data-country="{{ vendor.country or '' }}"
              data-address-2="{{ vendor.address_2 or '' }}"
            />
          </td>
          <td>{{ vendor.vendor_number }}</td>
          <td>{{ vendor.vendor_type or '-' }}</td>
          <td>{{ vendor.vendor_name }}</td>
          <td>{{ vendor.vendor_tax_number or '-' }}</td>
          <td>{{ vendor.registration_name or '-' }}</td>
          <td>{{ vendor.phone_number or '-' }}</td>
          <td>{{ vendor.address or '-' }}</td>
          <td>{{ vendor.website or '-' }}</td>
          <td>{{ vendor.country or '-' }}</td>
          <td>{{ vendor.address_2 or '-' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-muted text-center py-4">No vendors yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal modal-blur fade" id="addVendorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('add_vendor') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add Vendor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Type</label>
              <select class="form-select" name="vendor_type">
                <option value="Company" selected>Company</option>
                <option value="individual">individual</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Name</label>
              <input class="form-control" type="text" name="vendor_name" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Tax Number</label>
              <input class="form-control" type="text" name="vendor_tax_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Registration Name</label>
              <input class="form-control" type="text" name="registration_name" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone Number</label>
              <input class="form-control" type="text" name="phone_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Country</label>
              <input class="form-control" type="text" name="country" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Website</label>
              <input class="form-control" type="text" name="website" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Address 2</label>
              <textarea class="form-control" name="address_2" rows="2"></textarea>
            </div>
          </div>
          <div class="text-muted small">Vendor Number is generated automatically.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="editVendorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('edit_vendor') }}">
        <input type="hidden" name="vendor_id" id="edit_vendor_id" />
        <div class="modal-header">
          <h5 class="modal-title">Edit Vendor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Number</label>
              <input class="form-control" type="text" id="edit_vendor_number" disabled />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Type</label>
              <select class="form-select" name="vendor_type" id="edit_vendor_type">
                <option value="Company">Company</option>
                <option value="individual">individual</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Name</label>
              <input class="form-control" type="text" name="vendor_name" id="edit_vendor_name" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Vendor Tax Number</label>
              <input class="form-control" type="text" name="vendor_tax_number" id="edit_vendor_tax_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Registration Name</label>
              <input class="form-control" type="text" name="registration_name" id="edit_registration_name" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone Number</label>
              <input class="form-control" type="text" name="phone_number" id="edit_phone_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Country</label>
              <input class="form-control" type="text" name="country" id="edit_country" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Website</label>
              <input class="form-control" type="text" name="website" id="edit_website" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" id="edit_address" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Address 2</label>
              <textarea class="form-control" name="address_2" id="edit_address_2" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<form method="post" action="{{ url_for('delete_vendor') }}" id="deleteVendorForm" class="d-none">
  <input type="hidden" name="vendor_id" id="delete_vendor_id" />
</form>

<script>
  const editBtn = document.getElementById('editVendorButton');
  const deleteBtn = document.getElementById('deleteVendorButton');
  const radios = document.querySelectorAll('input[name="selected_vendor"]');
  const vendorRows = document.querySelectorAll('#vendorsTable tbody tr.vendor-row');
  const searchInput = document.getElementById('vendorsSearchInput');
  const searchForm = document.getElementById('vendorsSearchForm');
  const tableBody = document.querySelector('#vendorsTable tbody');
  const addModalEl = document.getElementById('addVendorModal');
  const editModalEl = document.getElementById('editVendorModal');

  function getSelectedVendor() {
    return document.querySelector('input[name="selected_vendor"]:checked');
  }

  function updateActionsState() {
    const selected = getSelectedVendor();
    const hasSelection = !!selected;
    editBtn.disabled = !hasSelection;
    deleteBtn.disabled = !hasSelection;
  }

  function applyTableFilter() {
    if (!searchInput || !tableBody) return;

    const query = searchInput.value.trim().toLowerCase();
    const dataRows = Array.from(tableBody.querySelectorAll('tr')).filter(
      (row) => row.querySelector('input[name="selected_vendor"]')
    );

    let visibleCount = 0;
    dataRows.forEach((row) => {
      const rowText = row.textContent.toLowerCase();
      const visible = !query || rowText.includes(query);
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount += 1;
    });

    let emptyRow = document.getElementById('vendors-filter-empty-row');
    if (visibleCount === 0 && dataRows.length > 0) {
      if (!emptyRow) {
        emptyRow = document.createElement('tr');
        emptyRow.id = 'vendors-filter-empty-row';
        emptyRow.innerHTML = '<td colspan="11" class="text-muted text-center py-4">No matching vendors.</td>';
        tableBody.appendChild(emptyRow);
      }
    } else if (emptyRow) {
      emptyRow.remove();
    }

    const selected = getSelectedVendor();
    if (selected && selected.closest('tr').style.display === 'none') {
      selected.checked = false;
    }
    updateActionsState();
  }

  function openEditVendorModal() {
    const selected = getSelectedVendor();
    if (!selected) {
      alert('Select a vendor first.');
      return;
    }

    document.getElementById('edit_vendor_id').value = selected.dataset.id;
    document.getElementById('edit_vendor_number').value = selected.dataset.vendorNumber;
    document.getElementById('edit_vendor_type').value = selected.dataset.vendorType || 'Company';
    document.getElementById('edit_vendor_name').value = selected.dataset.vendorName;
    document.getElementById('edit_vendor_tax_number').value = selected.dataset.vendorTaxNumber;
    document.getElementById('edit_registration_name').value = selected.dataset.registrationName;
    document.getElementById('edit_phone_number').value = selected.dataset.phoneNumber;
    document.getElementById('edit_address').value = selected.dataset.address;
    document.getElementById('edit_website').value = selected.dataset.website;
    document.getElementById('edit_country').value = selected.dataset.country;
    document.getElementById('edit_address_2').value = selected.dataset.address2;

    const modal = new bootstrap.Modal(editModalEl);
    modal.show();
  }

  radios.forEach((radio) => {
    radio.addEventListener('change', updateActionsState);
  });

  vendorRows.forEach((row) => {
    row.addEventListener('click', (event) => {
      const radio = row.querySelector('input[name="selected_vendor"]');
      if (!radio) return;

      if (event.target.tagName.toLowerCase() !== 'input') {
        radio.checked = true;
      }
      updateActionsState();
    });

    row.addEventListener('dblclick', () => {
      const radio = row.querySelector('input[name="selected_vendor"]');
      if (!radio) return;
      radio.checked = true;
      updateActionsState();
      openEditVendorModal();
    });
  });

  if (searchInput) {
    searchInput.addEventListener('input', applyTableFilter);
  }

  if (searchForm) {
    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyTableFilter();
    });
  }

  editBtn.addEventListener('click', openEditVendorModal);

  deleteBtn.addEventListener('click', () => {
    const selected = getSelectedVendor();
    if (!selected) return;

    showHtmlConfirm('Delete selected vendor?', () => {
      document.getElementById('delete_vendor_id').value = selected.dataset.id;
      document.getElementById('deleteVendorForm').submit();
    });
  });

  [addModalEl, editModalEl].forEach((modalEl) => {
    if (!modalEl) return;

    modalEl.addEventListener('hide.bs.modal', () => {
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }
    });
  });

  if (editModalEl) {
    editModalEl.addEventListener('hidden.bs.modal', () => {
      if (editBtn) editBtn.focus();
    });
  }

  if (addModalEl) {
    addModalEl.addEventListener('hidden.bs.modal', () => {
      const addBtn = document.querySelector('[data-bs-target="#addVendorModal"]');
      if (addBtn) addBtn.focus();
    });
  }

  updateActionsState();
  applyTableFilter();
</script>
{% endblock %}
