{% extends 'base.html' %}

{% block content %}
<div class="card">
  <div class="card-header d-flex align-items-center justify-content-between gap-2 flex-wrap">
    <div class="d-flex gap-2">
      <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
        Add Customer
      </button>
      <button type="button" class="btn btn-sm" id="editCustomerButton" disabled>
        Edit Customer
      </button>
      <button type="button" class="btn btn-sm btn-danger" id="deleteCustomerButton" disabled>
        Delete Customer
      </button>
    </div>

    <form id="customersSearchForm" method="get" action="{{ url_for('customers_page') }}" class="d-flex" style="max-width: 280px; width: 100%;">
      <div class="input-group input-group-sm">
        <input
          id="customersSearchInput"
          type="text"
          class="form-control"
          name="q"
          placeholder="Search customers..."
          value="{{ search_query or '' }}"
        />
        <button type="submit" class="btn btn-sm">Search</button>
      </div>
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-vcenter card-table" id="customersTable">
      <thead>
        <tr class="customer-row">
          <th style="width: 48px;"></th>
          <th>Customer Number</th>
          <th>Customer Type</th>
          <th>Customer Name</th>
          <th>Customer Tax Number</th>
          <th>Registration Name</th>
          <th>Phone Number</th>
          <th>Address</th>
          <th>Website</th>
          <th>Country</th>
          <th>Address 2</th>
        </tr>
      </thead>
      <tbody>
        {% for customer in customers %}
        <tr>
          <td>
            <input
              type="radio"
              name="selected_customer"
              value="{{ customer.id }}"
              data-id="{{ customer.id }}"
              data-customer-number="{{ customer.customer_number }}"
              data-customer-type="{{ customer.customer_type or 'Company' }}"
              data-customer-name="{{ customer.customer_name }}"
              data-customer-tax-number="{{ customer.customer_tax_number or '' }}"
              data-registration-name="{{ customer.registration_name or '' }}"
              data-phone-number="{{ customer.phone_number or '' }}"
              data-address="{{ customer.address or '' }}"
              data-website="{{ customer.website or '' }}"
              data-country="{{ customer.country or '' }}"
              data-address-2="{{ customer.address_2 or '' }}"
            />
          </td>
          <td>{{ customer.customer_number }}</td>
          <td>{{ customer.customer_type or '-' }}</td>
          <td>{{ customer.customer_name }}</td>
          <td>{{ customer.customer_tax_number or '-' }}</td>
          <td>{{ customer.registration_name or '-' }}</td>
          <td>{{ customer.phone_number or '-' }}</td>
          <td>{{ customer.address or '-' }}</td>
          <td>{{ customer.website or '-' }}</td>
          <td>{{ customer.country or '-' }}</td>
          <td>{{ customer.address_2 or '-' }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="text-muted text-center py-4">No customers yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="modal modal-blur fade" id="addCustomerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('add_customer') }}">
        <div class="modal-header">
          <h5 class="modal-title">Add Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Type</label>
              <select class="form-select" name="customer_type">
                <option value="Company" selected>Company</option>
                <option value="individual">individual</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Name</label>
              <input class="form-control" type="text" name="customer_name" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Tax Number</label>
              <input class="form-control" type="text" name="customer_tax_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Registration Name</label>
              <input class="form-control" type="text" name="registration_name" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone Number</label>
              <input class="form-control" type="text" name="phone_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Country</label>
              <input class="form-control" type="text" name="country" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Website</label>
              <input class="form-control" type="text" name="website" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Address 2</label>
              <textarea class="form-control" name="address_2" rows="2"></textarea>
            </div>
          </div>
          <div class="text-muted small">Customer Number is generated automatically.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="editCustomerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form method="post" action="{{ url_for('edit_customer') }}">
        <input type="hidden" name="customer_id" id="edit_customer_id" />
        <div class="modal-header">
          <h5 class="modal-title">Edit Customer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Number</label>
              <input class="form-control" type="text" id="edit_customer_number" disabled />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Type</label>
              <select class="form-select" name="customer_type" id="edit_customer_type">
                <option value="Company">Company</option>
                <option value="individual">individual</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Name</label>
              <input class="form-control" type="text" name="customer_name" id="edit_customer_name" required />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Customer Tax Number</label>
              <input class="form-control" type="text" name="customer_tax_number" id="edit_customer_tax_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Registration Name</label>
              <input class="form-control" type="text" name="registration_name" id="edit_registration_name" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Phone Number</label>
              <input class="form-control" type="text" name="phone_number" id="edit_phone_number" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Country</label>
              <input class="form-control" type="text" name="country" id="edit_country" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Website</label>
              <input class="form-control" type="text" name="website" id="edit_website" />
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" id="edit_address" rows="2"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Address 2</label>
              <textarea class="form-control" name="address_2" id="edit_address_2" rows="2"></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-sm btn-primary">Update</button>
        </div>
      </form>
    </div>
  </div>
</div>

<form method="post" action="{{ url_for('delete_customer') }}" id="deleteCustomerForm" class="d-none">
  <input type="hidden" name="customer_id" id="delete_customer_id" />
</form>

<script>
  const editBtn = document.getElementById('editCustomerButton');
  const deleteBtn = document.getElementById('deleteCustomerButton');
  const radios = document.querySelectorAll('input[name="selected_customer"]');
  const customerRows = document.querySelectorAll('#customersTable tbody tr.customer-row');
  const searchInput = document.getElementById('customersSearchInput');
  const searchForm = document.getElementById('customersSearchForm');
  const tableBody = document.querySelector('#customersTable tbody');
  const addModalEl = document.getElementById('addCustomerModal');
  const editModalEl = document.getElementById('editCustomerModal');

  function getSelectedCustomer() {
    return document.querySelector('input[name="selected_customer"]:checked');
  }

  function updateActionsState() {
    const selected = getSelectedCustomer();
    const hasSelection = !!selected;
    editBtn.disabled = !hasSelection;
    deleteBtn.disabled = !hasSelection;
  }

  function applyTableFilter() {
    if (!searchInput || !tableBody) return;

    const query = searchInput.value.trim().toLowerCase();
    const dataRows = Array.from(tableBody.querySelectorAll('tr')).filter(
      (row) => row.querySelector('input[name="selected_customer"]')
    );

    let visibleCount = 0;
    dataRows.forEach((row) => {
      const rowText = row.textContent.toLowerCase();
      const visible = !query || rowText.includes(query);
      row.style.display = visible ? '' : 'none';
      if (visible) visibleCount += 1;
    });

    let emptyRow = document.getElementById('customers-filter-empty-row');
    if (visibleCount === 0 && dataRows.length > 0) {
      if (!emptyRow) {
        emptyRow = document.createElement('tr');
        emptyRow.id = 'customers-filter-empty-row';
        emptyRow.innerHTML = '<td colspan="11" class="text-muted text-center py-4">No matching customers.</td>';
        tableBody.appendChild(emptyRow);
      }
    } else if (emptyRow) {
      emptyRow.remove();
    }

    const selected = getSelectedCustomer();
    if (selected && selected.closest('tr').style.display === 'none') {
      selected.checked = false;
    }
    updateActionsState();
  }

  radios.forEach((radio) => {
    radio.addEventListener('change', updateActionsState);
  });

  customerRows.forEach((row) => {
    row.addEventListener('click', (event) => {
      const radio = row.querySelector('input[name="selected_customer"]');
      if (!radio) return;

      if (event.target.tagName.toLowerCase() !== 'input') {
        radio.checked = true;
      }
      updateActionsState();
    });

    row.addEventListener('dblclick', () => {
      const radio = row.querySelector('input[name="selected_customer"]');
      if (!radio) return;
      radio.checked = true;
      updateActionsState();
      openEditCustomerModal();
    });
  });

  if (searchInput) {
    searchInput.addEventListener('input', applyTableFilter);
  }

  if (searchForm) {
    searchForm.addEventListener('submit', (event) => {
      event.preventDefault();
      applyTableFilter();
    });
  }

  function openEditCustomerModal() {
    const selected = getSelectedCustomer();
    if (!selected) {
      alert('Select a customer first.');
      return;
    }

    document.getElementById('edit_customer_id').value = selected.dataset.id;
    document.getElementById('edit_customer_number').value = selected.dataset.customerNumber;
    document.getElementById('edit_customer_type').value = selected.dataset.customerType || 'Company';
    document.getElementById('edit_customer_name').value = selected.dataset.customerName;
    document.getElementById('edit_customer_tax_number').value = selected.dataset.customerTaxNumber;
    document.getElementById('edit_registration_name').value = selected.dataset.registrationName;
    document.getElementById('edit_phone_number').value = selected.dataset.phoneNumber;
    document.getElementById('edit_address').value = selected.dataset.address;
    document.getElementById('edit_website').value = selected.dataset.website;
    document.getElementById('edit_country').value = selected.dataset.country;
    document.getElementById('edit_address_2').value = selected.dataset.address2;

    const modal = new bootstrap.Modal(document.getElementById('editCustomerModal'));
    modal.show();
  }

  editBtn.addEventListener('click', openEditCustomerModal);

  deleteBtn.addEventListener('click', () => {
    const selected = getSelectedCustomer();
    if (!selected) return;

    showHtmlConfirm('Delete selected customer?', () => {
      document.getElementById('delete_customer_id').value = selected.dataset.id;
      document.getElementById('deleteCustomerForm').submit();
    });
  });

  [addModalEl, editModalEl].forEach((modalEl) => {
    if (!modalEl) return;

    modalEl.addEventListener('hide.bs.modal', () => {
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }
    });
  });

  if (editModalEl) {
    editModalEl.addEventListener('hidden.bs.modal', () => {
      if (editBtn) editBtn.focus();
    });
  }

  if (addModalEl) {
    addModalEl.addEventListener('hidden.bs.modal', () => {
      const addBtn = document.querySelector('[data-bs-target="#addCustomerModal"]');
      if (addBtn) addBtn.focus();
    });
  }

  updateActionsState();
  applyTableFilter();
</script>
{% endblock %}
